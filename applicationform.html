<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>StudentDesk | Service Request</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body>

<div class="page-wrapper min-h-screen bg-gradient-to-b from-blue-200 to-white">

<!-- Header -->
<div class="header-nav flex justify-between items-center px-8 py-4 bg-white shadow">
  <img src="assets/frame9.png" class="h-10">
  <button onclick="history.back()" class="px-4 py-2 bg-blue-100 rounded-lg">← Back</button>
</div>

<!-- Form Card -->
<div class="max-w-4xl mx-auto mt-10 bg-white p-8 rounded-xl shadow-xl">

<h2 class="text-3xl font-bold mb-6 text-center">Service Request Form</h2>

<form id="serviceForm">

<!-- Personal Info -->
<div class="grid grid-cols-2 gap-4">
  <input id="name" placeholder="Full Name" class="border p-3 rounded" required>
  <input id="email" placeholder="Email" class="border p-3 rounded" required>
  <input id="phone" placeholder="Phone" class="border p-3 rounded" required>
</div>

<!-- Service Type -->
<div class="mt-6">
  <label class="font-semibold">Select Request Type</label>
  <select id="serviceType" class="w-full border p-3 rounded mt-2" required>
    <option value="">Select service</option>
    <option>Bonafide Certificate</option>
    <option>Transfer Certificate</option>
    <option>Character Certificate</option>
  </select>
</div>

<!-- Purpose -->
<div class="mt-6">
  <textarea id="purpose" class="w-full border p-3 rounded" rows="4" placeholder="Purpose of request..." required></textarea>
</div>

<!-- Upload -->
<div class="mt-6">
  <label class="font-semibold">Upload Supporting Document</label>
  <div id="uploadBox" class="mt-3 p-6 border-2 border-dashed rounded-lg text-center cursor-pointer">
    Click to upload (PDF, JPG, PNG)
    <input type="file" id="fileInput" hidden accept=".pdf,.jpg,.jpeg,.png">
    <div id="fileName" class="mt-2 text-green-600"></div>
  </div>
</div>

<!-- Buttons -->
<div class="flex justify-between mt-8">
  <button type="button" class="px-6 py-3 bg-blue-100 rounded-lg" id="saveDraft">Save Draft</button>
  <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg">Submit Request</button>
</div>

</form>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const app = initializeApp({
  apiKey: "AIzaSyBKUqT8CBiz7c-j2ew91TBHPb9X0NzqpqE",
  authDomain: "studentdesk-72aed.firebaseapp.com",
  projectId: "studentdesk-72aed",
  storageBucket: "studentdesk-72aed.appspot.com",
});

const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUser;
let uploadedFile = null;

onAuthStateChanged(auth, user=>{
  if(!user) location.href="login.html";
  currentUser = user;
});

// Upload handling
uploadBox.onclick = ()=>fileInput.click();

fileInput.onchange = ()=>{
  uploadedFile = fileInput.files[0];
  fileName.textContent = "✓ " + uploadedFile.name;
};

// Save Draft
saveDraft.onclick = ()=>{
  alert("Draft saved (prototype)");
};

// Submit Request
serviceForm.onsubmit = async (e)=>{
  e.preventDefault();

  let fileURL = "";

  if(uploadedFile){
    const fileRef = ref(storage,"requests/"+currentUser.uid+"/"+Date.now());
    await uploadBytes(fileRef,uploadedFile);
    fileURL = await getDownloadURL(fileRef);
  }

  const reqId = Date.now().toString();

  await setDoc(doc(db,"serviceRequests",currentUser.uid,"list",reqId),{
    name:name.value,
    email:email.value,
    phone:phone.value,
    serviceType:serviceType.value,
    purpose:purpose.value,
    file:fileURL,
    status:"Pending",
    createdAt:new Date()
  });

  alert("Request submitted!");
  location.href="studentdb.html";
};
</script>

</body>
</html>
